# This workflow generates the Windows installer (MSI)
# It must be executed manually
name: Build the MSI Package

on:
  # push:
  #   branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # Checks-out the repository under ${{ github.workspace }}, so the job can access it
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # important for WiX working properly

      - name: Install dependencies on Windows
        run: |
          choco install cmake
          cmake --version
          choco install wixtoolset --version 3.14.0.6528 -y
          echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
        working-directory: ${{ github.workspace }}

      - name: Build CMake project
        run: |
          cmake --build . --config Release
        working-directory: ${{ github.workspace }}/build

      - name: Generate the MSI package
        run: |
          msbuild "agrilla.wixproj" /p:Configuration=Release

      - name: Upload MSI package
        uses: actions/upload-artifact@v4
        with:
          name: agrilla-msi-installer
          path: bin\Release\agrilla.msi

